"use strict";var Faye={VERSION:"0.8.9",BAYEUX_VERSION:"1.0",ID_LENGTH:160,JSONP_CALLBACK:"jsonpcallback",CONNECTION_TYPES:["long-polling","cross-origin-long-polling","callback-polling","websocket","eventsource","in-process"],MANDATORY_CONNECTION_TYPES:["long-polling","callback-polling","in-process"],ENV:"undefined"==typeof global?window:global,extend:function(e,t,n){if(!t)return e;for(var s in t)t.hasOwnProperty(s)&&(e.hasOwnProperty(s)&&n===!1||e[s]!==t[s]&&(e[s]=t[s]));return e},random:function(e){if(e=e||this.ID_LENGTH,e>32){for(var t=Math.ceil(e/32),n="";t--;)n+=this.random(32);for(var s=n.split(""),i="";s.length>0;)i+=s.pop();return i}for(var r=Math.pow(2,e)-1,a=r.toString(36).length,n=Math.floor(Math.random()*r).toString(36);n.length<a;)n="0"+n;return n},clientIdFromMessages:function(e){var t=[].concat(e)[0];return t&&t.clientId},copyObject:function(e){var t,n,s;if(e instanceof Array){for(t=[],n=e.length;n--;)t[n]=Faye.copyObject(e[n]);return t}if("object"==typeof e){t=null===e?null:{};for(s in e)t[s]=Faye.copyObject(e[s]);return t}return e},commonElement:function(e,t){for(var n=0,s=e.length;s>n;n++)if(-1!==this.indexOf(t,e[n]))return e[n];return null},indexOf:function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,s=e.length;s>n;n++)if(e[n]===t)return n;return-1},map:function(e,t,n){if(e.map)return e.map(t,n);var s=[];if(e instanceof Array)for(var i=0,r=e.length;r>i;i++)s.push(t.call(n||null,e[i],i));else for(var a in e)e.hasOwnProperty(a)&&s.push(t.call(n||null,a,e[a]));return s},filter:function(e,t,n){for(var s=[],i=0,r=e.length;r>i;i++)t.call(n||null,e[i],i)&&s.push(e[i]);return s},asyncEach:function(e,t,n,s){var i=e.length,r=-1,a=0,o=!1,c=function(){return a-=1,r+=1,r===i?n&&n.call(s):void t(e[r],h)},u=function(){if(!o){for(o=!0;a>0;)c();o=!1}},h=function(){a+=1,u()};h()},toJSON:function(e){return this.stringify?this.stringify(e,function(e,t){return this[e]instanceof Array?this[e]:t}):JSON.stringify(e)},logger:function(e){"undefined"!=typeof console&&console.log(e)},timestamp:function(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,s=e.getDate(),i=e.getHours(),r=e.getMinutes(),a=e.getSeconds(),o=function(e){return 10>e?"0"+e:String(e)};return o(t)+"-"+o(n)+"-"+o(s)+" "+o(i)+":"+o(r)+":"+o(a)}};"undefined"!=typeof window&&(window.Faye=Faye),Faye.Class=function(e,t){"function"!=typeof e&&(t=e,e=Object);var n=function(){return this.initialize?this.initialize.apply(this,arguments)||this:this},s=function(){};return s.prototype=e.prototype,n.prototype=new s,Faye.extend(n.prototype,t),n},Faye.Namespace=Faye.Class({initialize:function(){this._used={}},exists:function(e){return this._used.hasOwnProperty(e)},generate:function(){for(var e=Faye.random();this._used.hasOwnProperty(e);)e=Faye.random();return this._used[e]=e},release:function(e){delete this._used[e]}}),Faye.Error=Faye.Class({initialize:function(e,t,n){this.code=e,this.params=Array.prototype.slice.call(t),this.message=n},toString:function(){return this.code+":"+this.params.join(",")+":"+this.message}}),Faye.Error.parse=function(e){if(e=e||"",!Faye.Grammar.ERROR.test(e))return new this(null,[],e);var t=e.split(":"),n=parseInt(t[0]),s=t[1].split(","),e=t[2];return new this(n,s,e)},Faye.Error.versionMismatch=function(){return new this(300,arguments,"Version mismatch").toString()},Faye.Error.conntypeMismatch=function(){return new this(301,arguments,"Connection types not supported").toString()},Faye.Error.extMismatch=function(){return new this(302,arguments,"Extension mismatch").toString()},Faye.Error.badRequest=function(){return new this(400,arguments,"Bad request").toString()},Faye.Error.clientUnknown=function(){return new this(401,arguments,"Unknown client").toString()},Faye.Error.parameterMissing=function(){return new this(402,arguments,"Missing required parameter").toString()},Faye.Error.channelForbidden=function(){return new this(403,arguments,"Forbidden channel").toString()},Faye.Error.channelUnknown=function(){return new this(404,arguments,"Unknown channel").toString()},Faye.Error.channelInvalid=function(){return new this(405,arguments,"Invalid channel").toString()},Faye.Error.extUnknown=function(){return new this(406,arguments,"Unknown extension").toString()},Faye.Error.publishFailed=function(){return new this(407,arguments,"Failed to publish").toString()},Faye.Error.serverError=function(){return new this(500,arguments,"Internal server error").toString()},Faye.Deferrable={callback:function(e,t){if(e){if("succeeded"===this._deferredStatus)return e.apply(t,this._deferredArgs);this._callbacks=this._callbacks||[],this._callbacks.push([e,t])}},timeout:function(e,t){var n=this,s=Faye.ENV.setTimeout(function(){n.setDeferredStatus("failed",t)},1e3*e);this._timer=s},errback:function(e,t){if(e){if("failed"===this._deferredStatus)return e.apply(t,this._deferredArgs);this._errbacks=this._errbacks||[],this._errbacks.push([e,t])}},setDeferredStatus:function(){this._timer&&Faye.ENV.clearTimeout(this._timer);var e,t=Array.prototype.slice.call(arguments),n=t.shift();if(this._deferredStatus=n,this._deferredArgs=t,"succeeded"===n?e=this._callbacks:"failed"===n&&(e=this._errbacks),e)for(var s;s=e.shift();)s[0].apply(s[1],this._deferredArgs)}},Faye.Publisher={countListeners:function(e){return this._subscribers&&this._subscribers[e]?this._subscribers[e].length:0},bind:function(e,t,n){this._subscribers=this._subscribers||{};var s=this._subscribers[e]=this._subscribers[e]||[];s.push([t,n])},unbind:function(e,t,n){if(this._subscribers&&this._subscribers[e]){if(!t)return void delete this._subscribers[e];for(var s=this._subscribers[e],i=s.length;i--;)t===s[i][0]&&(n&&s[i][1]!==n||s.splice(i,1))}},trigger:function(){var e=Array.prototype.slice.call(arguments),t=e.shift();if(this._subscribers&&this._subscribers[t])for(var n,s=this._subscribers[t].slice(),i=0,r=s.length;r>i;i++)n=s[i],n[0].apply(n[1],e)}},Faye.Timeouts={addTimeout:function(e,t,n,s){if(this._timeouts=this._timeouts||{},!this._timeouts.hasOwnProperty(e)){var i=this;this._timeouts[e]=Faye.ENV.setTimeout(function(){delete i._timeouts[e],n.call(s)},1e3*t)}},removeTimeout:function(e){this._timeouts=this._timeouts||{};var t=this._timeouts[e];t&&(clearTimeout(t),delete this._timeouts[e])}},Faye.Logging={LOG_LEVELS:{error:3,warn:2,info:1,debug:0},logLevel:"error",log:function(e,t){if(Faye.logger){var n=Faye.Logging.LOG_LEVELS;if(!(n[Faye.Logging.logLevel]>n[t])){var e=Array.prototype.slice.apply(e),s=" ["+t.toUpperCase()+"] [Faye",i=this.className,r=e.shift().replace(/\?/g,function(){try{return Faye.toJSON(e.shift())}catch(t){return"[Object]"}});for(var a in Faye)i||"function"==typeof Faye[a]&&this instanceof Faye[a]&&(i=a);i&&(s+="."+i),s+="] ",Faye.logger(Faye.timestamp()+s+r)}}}},function(){for(var e in Faye.Logging.LOG_LEVELS)(function(e,t){Faye.Logging[e]=function(){this.log(arguments,e)}})(e,Faye.Logging.LOG_LEVELS[e])}(),Faye.Grammar={LOWALPHA:/^[a-z]$/,UPALPHA:/^[A-Z]$/,ALPHA:/^([a-z]|[A-Z])$/,DIGIT:/^[0-9]$/,ALPHANUM:/^(([a-z]|[A-Z])|[0-9])$/,MARK:/^(\-|\_|\!|\~|\(|\)|\$|\@)$/,STRING:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,TOKEN:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,INTEGER:/^([0-9])+$/,CHANNEL_SEGMENT:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+$/,CHANNEL_SEGMENTS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,CHANNEL_NAME:/^\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*$/,WILD_CARD:/^\*{1,2}$/,CHANNEL_PATTERN:/^(\/(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)))+)*\/\*{1,2}$/,VERSION_ELEMENT:/^(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*$/,VERSION:/^([0-9])+(\.(([a-z]|[A-Z])|[0-9])(((([a-z]|[A-Z])|[0-9])|\-|\_))*)*$/,CLIENT_ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ID:/^((([a-z]|[A-Z])|[0-9]))+$/,ERROR_MESSAGE:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*$/,ERROR_ARGS:/^(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*$/,ERROR_CODE:/^[0-9][0-9][0-9]$/,ERROR:/^([0-9][0-9][0-9]:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*(,(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)*:(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*|[0-9][0-9][0-9]::(((([a-z]|[A-Z])|[0-9])|(\-|\_|\!|\~|\(|\)|\$|\@)| |\/|\*|\.))*)$/},Faye.Extensible={addExtension:function(e){this._extensions=this._extensions||[],this._extensions.push(e),e.added&&e.added(this)},removeExtension:function(e){if(this._extensions)for(var t=this._extensions.length;t--;)this._extensions[t]===e&&(this._extensions.splice(t,1),e.removed&&e.removed(this))},pipeThroughExtensions:function(e,t,n,s){if(this.debug("Passing through ? extensions: ?",e,t),!this._extensions)return n.call(s,t);var i=this._extensions.slice(),r=function(t){if(!t)return n.call(s,t);var a=i.shift();return a?void(a[e]?a[e](t,r):r(t)):n.call(s,t)};r(t)}},Faye.extend(Faye.Extensible,Faye.Logging),Faye.Channel=Faye.Class({initialize:function(e){this.id=this.name=e},push:function(e){this.trigger("message",e)},isUnused:function(){return 0===this.countListeners("message")}}),Faye.extend(Faye.Channel.prototype,Faye.Publisher),Faye.extend(Faye.Channel,{HANDSHAKE:"/meta/handshake",CONNECT:"/meta/connect",SUBSCRIBE:"/meta/subscribe",UNSUBSCRIBE:"/meta/unsubscribe",DISCONNECT:"/meta/disconnect",META:"meta",SERVICE:"service",expand:function(e){var t=this.parse(e),n=["/**",e],s=t.slice();s[s.length-1]="*",n.push(this.unparse(s));for(var i=1,r=t.length;r>i;i++)s=t.slice(0,i),s.push("**"),n.push(this.unparse(s));return n},isValid:function(e){return Faye.Grammar.CHANNEL_NAME.test(e)||Faye.Grammar.CHANNEL_PATTERN.test(e)},parse:function(e){return this.isValid(e)?e.split("/").slice(1):null},unparse:function(e){return"/"+e.join("/")},isMeta:function(e){var t=this.parse(e);return t?t[0]===this.META:null},isService:function(e){var t=this.parse(e);return t?t[0]===this.SERVICE:null},isSubscribable:function(e){return this.isValid(e)?!this.isMeta(e)&&!this.isService(e):null},Set:Faye.Class({initialize:function(){this._channels={}},getKeys:function(){var e=[];for(var t in this._channels)e.push(t);return e},remove:function(e){delete this._channels[e]},hasSubscription:function(e){return this._channels.hasOwnProperty(e)},subscribe:function(e,t,n){if(t)for(var s,i=0,r=e.length;r>i;i++){s=e[i];var a=this._channels[s]=this._channels[s]||new Faye.Channel(s);a.bind("message",t,n)}},unsubscribe:function(e,t,n){var s=this._channels[e];return s?(s.unbind("message",t,n),s.isUnused()?(this.remove(e),!0):!1):!1},distributeMessage:function(e){for(var t=Faye.Channel.expand(e.channel),n=0,s=t.length;s>n;n++){var i=this._channels[t[n]];i&&i.trigger("message",e.data)}}})}),Faye.Publication=Faye.Class(Faye.Deferrable),Faye.Subscription=Faye.Class({initialize:function(e,t,n,s){this._client=e,this._channels=t,this._callback=n,this._context=s,this._cancelled=!1},cancel:function(){this._cancelled||(this._client.unsubscribe(this._channels,this._callback,this._context),this._cancelled=!0)},unsubscribe:function(){this.cancel()}}),Faye.extend(Faye.Subscription.prototype,Faye.Deferrable),Faye.Client=Faye.Class({UNCONNECTED:1,CONNECTING:2,CONNECTED:3,DISCONNECTED:4,HANDSHAKE:"handshake",RETRY:"retry",NONE:"none",CONNECTION_TIMEOUT:60,DEFAULT_RETRY:5,DEFAULT_ENDPOINT:"/bayeux",INTERVAL:0,initialize:function(e,t){this.info("New client created for ?",e),this._options=t||{},this.endpoint=e||this.DEFAULT_ENDPOINT,this.endpoints=this._options.endpoints||{},this.transports={},this._cookies=Faye.CookieJar&&new Faye.CookieJar,this._headers={},this._disabled=[],this.retry=this._options.retry||this.DEFAULT_RETRY,this._state=this.UNCONNECTED,this._channels=new Faye.Channel.Set,this._messageId=0,this._responseCallbacks={},this._advice={reconnect:this.RETRY,interval:1e3*(this._options.interval||this.INTERVAL),timeout:1e3*(this._options.timeout||this.CONNECTION_TIMEOUT)},Faye.Event&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.indexOf(this._disabled,"autodisconnect")<0&&this.disconnect()},this)},disable:function(e){this._disabled.push(e)},setHeader:function(e,t){this._headers[e]=t},getClientId:function(){return this._clientId},getState:function(){switch(this._state){case this.UNCONNECTED:return"UNCONNECTED";case this.CONNECTING:return"CONNECTING";case this.CONNECTED:return"CONNECTED";case this.DISCONNECTED:return"DISCONNECTED"}},handshake:function(e,t){if(this._advice.reconnect!==this.NONE&&this._state===this.UNCONNECTED){this._state=this.CONNECTING;var n=this;this.info("Initiating handshake with ?",this.endpoint),this._selectTransport(Faye.MANDATORY_CONNECTION_TYPES),this._send({channel:Faye.Channel.HANDSHAKE,version:Faye.BAYEUX_VERSION,supportedConnectionTypes:[this._transport.connectionType]},function(s){s.successful?(this._state=this.CONNECTED,this._clientId=s.clientId,this._selectTransport(s.supportedConnectionTypes),this.info("Handshake successful: ?",this._clientId),this.subscribe(this._channels.getKeys(),!0),e&&e.call(t)):(this.info("Handshake unsuccessful"),Faye.ENV.setTimeout(function(){n.handshake(e,t)},this._advice.interval),this._state=this.UNCONNECTED)},this)}},connect:function(e,t){if(this._advice.reconnect!==this.NONE&&this._state!==this.DISCONNECTED){if(this._state===this.UNCONNECTED)return this.handshake(function(){this.connect(e,t)},this);this.callback(e,t),this._state===this.CONNECTED&&(this.info("Calling deferred actions for ?",this._clientId),this.setDeferredStatus("succeeded"),this.setDeferredStatus("deferred"),this._connectRequest||(this._connectRequest=!0,this.info("Initiating connection for ?",this._clientId),this._send({channel:Faye.Channel.CONNECT,clientId:this._clientId,connectionType:this._transport.connectionType},this._cycleConnection,this)))}},disconnect:function(){this._state===this.CONNECTED&&(this._state=this.DISCONNECTED,this.info("Disconnecting ?",this._clientId),this._send({channel:Faye.Channel.DISCONNECT,clientId:this._clientId},function(e){e.successful&&this._transport.close()},this),this.info("Clearing channel listeners for ?",this._clientId),this._channels=new Faye.Channel.Set)},subscribe:function(e,t,n){if(e instanceof Array)return Faye.map(e,function(e){return this.subscribe(e,t,n)},this);var s=new Faye.Subscription(this,e,t,n),i=t===!0,r=this._channels.hasSubscription(e);return r&&!i?(this._channels.subscribe([e],t,n),s.setDeferredStatus("succeeded"),s):(this.connect(function(){this.info("Client ? attempting to subscribe to ?",this._clientId,e),i||this._channels.subscribe([e],t,n),this._send({channel:Faye.Channel.SUBSCRIBE,clientId:this._clientId,subscription:e},function(i){if(!i.successful)return s.setDeferredStatus("failed",Faye.Error.parse(i.error)),this._channels.unsubscribe(e,t,n);var r=[].concat(i.subscription);this.info("Subscription acknowledged for ? to ?",this._clientId,r),s.setDeferredStatus("succeeded")},this)},this),s)},unsubscribe:function(e,t,n){if(e instanceof Array)return Faye.map(e,function(e){return this.unsubscribe(e,t,n)},this);var s=this._channels.unsubscribe(e,t,n);s&&this.connect(function(){this.info("Client ? attempting to unsubscribe from ?",this._clientId,e),this._send({channel:Faye.Channel.UNSUBSCRIBE,clientId:this._clientId,subscription:e},function(e){if(e.successful){var t=[].concat(e.subscription);this.info("Unsubscription acknowledged for ? from ?",this._clientId,t)}},this)},this)},publish:function(e,t){var n=new Faye.Publication;return this.connect(function(){this.info("Client ? queueing published message to ?: ?",this._clientId,e,t),this._send({channel:e,data:t,clientId:this._clientId},function(e){e.successful?n.setDeferredStatus("succeeded"):n.setDeferredStatus("failed",Faye.Error.parse(e.error))},this)},this),n},receiveMessage:function(e){this.pipeThroughExtensions("incoming",e,function(e){if(e&&(e.advice&&this._handleAdvice(e.advice),this._deliverMessage(e),void 0!==e.successful)){var t=this._responseCallbacks[e.id];t&&(delete this._responseCallbacks[e.id],t[0].call(t[1],e))}},this)},_selectTransport:function(e){Faye.Transport.get(this,e,this._disabled,function(e){this.debug("Selected ? transport for ?",e.connectionType,e.endpoint),e!==this._transport&&(this._transport&&this._transport.close(),this._transport=e,this._transport.cookies=this._cookies,this._transport.headers=this._headers,e.bind("down",function(){(void 0===this._transportUp||this._transportUp)&&(this._transportUp=!1,this.trigger("transport:down"))},this),e.bind("up",function(){void 0!==this._transportUp&&this._transportUp||(this._transportUp=!0,this.trigger("transport:up"))},this))},this)},_send:function(e,t,n){e.id=this._generateMessageId(),t&&(this._responseCallbacks[e.id]=[t,n]),this.pipeThroughExtensions("outgoing",e,function(e){e&&this._transport.send(e,this._advice.timeout/1e3)},this)},_generateMessageId:function(){return this._messageId+=1,this._messageId>=Math.pow(2,32)&&(this._messageId=0),this._messageId.toString(36)},_handleAdvice:function(e){Faye.extend(this._advice,e),this._advice.reconnect===this.HANDSHAKE&&this._state!==this.DISCONNECTED&&(this._state=this.UNCONNECTED,this._clientId=null,this._cycleConnection())},_deliverMessage:function(e){e.channel&&void 0!==e.data&&(this.info("Client ? calling listeners for ? with ?",this._clientId,e.channel,e.data),this._channels.distributeMessage(e))},_teardownConnection:function(){this._connectRequest&&(this._connectRequest=null,this.info("Closed connection for ?",this._clientId))},_cycleConnection:function(){this._teardownConnection();var e=this;Faye.ENV.setTimeout(function(){e.connect()},this._advice.interval)}}),Faye.extend(Faye.Client.prototype,Faye.Deferrable),Faye.extend(Faye.Client.prototype,Faye.Publisher),Faye.extend(Faye.Client.prototype,Faye.Logging),Faye.extend(Faye.Client.prototype,Faye.Extensible),Faye.Transport=Faye.extend(Faye.Class({MAX_DELAY:0,batching:!0,initialize:function(e,t){this._client=e,this.endpoint=t,this._outbox=[]},close:function(){},send:function(e,t){return this.debug("Client ? sending message to ?: ?",this._client._clientId,this.endpoint,e),this.batching?(this._outbox.push(e),this._timeout=t,e.channel===Faye.Channel.HANDSHAKE?this.addTimeout("publish",.01,this.flush,this):(e.channel===Faye.Channel.CONNECT&&(this._connectMessage=e),this.shouldFlush&&this.shouldFlush(this._outbox)?this.flush():void this.addTimeout("publish",this.MAX_DELAY,this.flush,this))):this.request([e],t)},flush:function(){this.removeTimeout("publish"),this._outbox.length>1&&this._connectMessage&&(this._connectMessage.advice={timeout:0}),this.request(this._outbox,this._timeout),this._connectMessage=null,this._outbox=[]},receive:function(e){this.debug("Client ? received from ?: ?",this._client._clientId,this.endpoint,e);for(var t=0,n=e.length;n>t;t++)this._client.receiveMessage(e[t])},retry:function(e,t){var n=!1,s=1e3*this._client.retry,i=this;return function(){n||(n=!0,Faye.ENV.setTimeout(function(){i.request(e,t)},s))}}}),{MAX_URL_LENGTH:2048,get:function(e,t,n,s,i){var r=e.endpoint;Faye.asyncEach(this._transports,function(a,o){var c=a[0],u=a[1],h=e.endpoints[c]||r;return Faye.indexOf(n,c)>=0?o():Faye.indexOf(t,c)<0?(u.isUsable(e,h,function(){}),o()):void u.isUsable(e,h,function(t){if(!t)return o();var n=u.hasOwnProperty("create")?u.create(e,h):new u(e,h);s.call(i,n)})},function(){throw new Error("Could not find a usable connection type for "+r)})},register:function(e,t){this._transports.push([e,t]),t.prototype.connectionType=e},_transports:[]}),Faye.extend(Faye.Transport.prototype,Faye.Logging),Faye.extend(Faye.Transport.prototype,Faye.Publisher),Faye.extend(Faye.Transport.prototype,Faye.Timeouts),Faye.Event={_registry:[],on:function(e,t,n,s){var i=function(){n.call(s)};e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent("on"+t,i),this._registry.push({_element:e,_type:t,_callback:n,_context:s,_handler:i})},detach:function(e,t,n,s){for(var i,r=this._registry.length;r--;)i=this._registry[r],e&&e!==i._element||t&&t!==i._type||n&&n!==i._callback||s&&s!==i._context||(i._element.removeEventListener?i._element.removeEventListener(i._type,i._handler,!1):i._element.detachEvent("on"+i._type,i._handler),this._registry.splice(r,1),i=null)}},Faye.Event.on(Faye.ENV,"unload",Faye.Event.detach,Faye.Event),Faye.URI=Faye.extend(Faye.Class({queryString:function(){var e=[];for(var t in this.params)this.params.hasOwnProperty(t)&&e.push(encodeURIComponent(t)+"="+encodeURIComponent(this.params[t]));return e.join("&")},isSameOrigin:function(){var e=Faye.URI.parse(Faye.ENV.location.href,!1),t=e.hostname!==this.hostname||e.port!==this.port||e.protocol!==this.protocol;return!t},toURL:function(){var e=this.queryString();return this.protocol+"//"+this.hostname+(this.port?":"+this.port:"")+this.pathname+(e?"?"+e:"")+this.hash}}),{parse:function(e,t){if("string"!=typeof e)return e;var n,s=new this,i=function(t,n,i){e=e.replace(n,function(e){return s[t]=e,""}),void 0===s[t]&&(s[t]=i?Faye.ENV.location[t]:"")};if(i("protocol",/^https?\:/,!0),i("host",/^\/\/[^\/]+/,!0),/^\//.test(e)||(e=Faye.ENV.location.pathname.replace(/[^\/]*$/,"")+e),i("pathname",/^\/[^\?#]*/),i("search",/^\?[^#]*/),i("hash",/^#.*/),/^\/\//.test(s.host)?(s.host=s.host.substr(2),n=s.host.split(":"),s.hostname=n[0],s.port=n[1]||""):(s.hostname=Faye.ENV.location.hostname,s.port=Faye.ENV.location.port),t===!1)s.params={};else{for(var r=s.search.replace(/^\?/,""),a=r?r.split("&"):[],o=a.length,c={};o--;)n=a[o].split("="),c[decodeURIComponent(n[0]||"")]=decodeURIComponent(n[1]||"");"object"==typeof t&&Faye.extend(c,t),s.params=c}return s}}),this.JSON||(JSON={}),function(){function f(e){return 10>e?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,s,i,r,a,o=gap,c=t[e];switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(c=c.toJSON(e)),"function"==typeof rep&&(c=rep.call(t,e,c)),typeof c){case"string":return quote(c);case"number":return isFinite(c)?String(c):"null";case"boolean":case"null":return String(c);case"object":if(!c)return"null";if(gap+=indent,a=[],"[object Array]"===Object.prototype.toString.apply(c)){for(r=c.length,n=0;r>n;n+=1)a[n]=str(n,c)||"null";return i=0===a.length?"[]":gap?"[\n"+gap+a.join(",\n"+gap)+"\n"+o+"]":"["+a.join(",")+"]",gap=o,i}if(rep&&"object"==typeof rep)for(r=rep.length,n=0;r>n;n+=1)s=rep[n],"string"==typeof s&&(i=str(s,c),i&&a.push(quote(s)+(gap?": ":":")+i));else for(s in c)Object.hasOwnProperty.call(c,s)&&(i=str(s,c),i&&a.push(quote(s)+(gap?": ":":")+i));return i=0===a.length?"{}":gap?"{\n"+gap+a.join(",\n"+gap)+"\n"+o+"}":"{"+a.join(",")+"}",gap=o,i}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(e){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(e){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;Faye.stringify=function(e,t,n){var s;if(gap="",indent="","number"==typeof n)for(s=0;n>s;s+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})},"function"!=typeof JSON.stringify&&(JSON.stringify=Faye.stringify),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var n,s,i=e[t];if(i&&"object"==typeof i)for(n in i)Object.hasOwnProperty.call(i,n)&&(s=walk(i,n),void 0!==s?i[n]=s:delete i[n]);return reviver.call(e,t,i)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),Faye.Transport.WebSocket=Faye.extend(Faye.Class(Faye.Transport,{UNCONNECTED:1,CONNECTING:2,CONNECTED:3,batching:!1,isUsable:function(e,t){this.callback(function(){e.call(t,!0)}),this.errback(function(){e.call(t,!1)}),this.connect()},request:function(e,t){if(0!==e.length){this._messages=this._messages||{};for(var n=0,s=e.length;s>n;n++)this._messages[e[n].id]=e[n];this.callback(function(t){t.send(Faye.toJSON(e))}),this.connect()}},close:function(){this._socket&&(this._socket.onclose=this._socket.onerror=null,this._socket.close(),delete this._socket,this.setDeferredStatus("deferred"),this._state=this.UNCONNECTED)},connect:function(){if(!Faye.Transport.WebSocket._unloaded&&(this._state=this._state||this.UNCONNECTED,this._state===this.UNCONNECTED)){this._state=this.CONNECTING;var e=Faye.Transport.WebSocket.getClass();if(!e)return this.setDeferredStatus("failed");this._socket=new e(Faye.Transport.WebSocket.getSocketUrl(this.endpoint));var t=this;this._socket.onopen=function(){t._state=t.CONNECTED,t._everConnected=!0,t.setDeferredStatus("succeeded",t._socket),t.trigger("up")},this._socket.onmessage=function(e){var n=JSON.parse(e.data);if(n){n=[].concat(n);for(var s=0,i=n.length;i>s;s++)delete t._messages[n[s].id];t.receive(n)}},this._socket.onclose=this._socket.onerror=function(){var e=t._state===t.CONNECTED;if(t.setDeferredStatus("deferred"),t._state=t.UNCONNECTED,t.close(),e)return t.resend();if(!t._everConnected)return t.setDeferredStatus("failed");var n=1e3*t._client.retry;Faye.ENV.setTimeout(function(){t.connect()},n),t.trigger("down")}}},resend:function(){if(this._messages){var e=Faye.map(this._messages,function(e,t){return t});this.request(e)}}}),{getSocketUrl:function(e){return Faye.URI&&(e=Faye.URI.parse(e).toURL()),e.replace(/^http(s?):/gi,"ws$1:")},getClass:function(){return Faye.WebSocket&&Faye.WebSocket.Client||Faye.ENV.WebSocket||Faye.ENV.MozWebSocket},isUsable:function(e,t,n,s){this.create(e,t).isUsable(n,s)},create:function(e,t){var n=e.transports.websocket=e.transports.websocket||{};return n[t]=n[t]||new this(e,t),n[t]}}),Faye.extend(Faye.Transport.WebSocket.prototype,Faye.Deferrable),Faye.Transport.register("websocket",Faye.Transport.WebSocket),Faye.Event&&Faye.Event.on(Faye.ENV,"beforeunload",function(){Faye.Transport.WebSocket._unloaded=!0}),Faye.Transport.EventSource=Faye.extend(Faye.Class(Faye.Transport,{initialize:function(e,t){if(Faye.Transport.prototype.initialize.call(this,e,t),!Faye.ENV.EventSource)return this.setDeferredStatus("failed");this._xhr=new Faye.Transport.XHR(e,t);var n=new EventSource(t+"/"+e.getClientId()),s=this;n.onopen=function(){s._everConnected=!0,s.setDeferredStatus("succeeded"),s.trigger("up")},n.onerror=function(){s._everConnected?s.trigger("down"):(s.setDeferredStatus("failed"),n.close())},n.onmessage=function(e){s.receive(JSON.parse(e.data)),s.trigger("up")},this._socket=n},isUsable:function(e,t){this.callback(function(){e.call(t,!0)}),this.errback(function(){e.call(t,!1)})},request:function(e,t){this._xhr.request(e,t)},close:function(){this._socket&&(this._socket.onerror=null,this._socket.close(),delete this._socket)}}),{isUsable:function(e,t,n,s){var i=e.getClientId();return i?void Faye.Transport.XHR.isUsable(e,t,function(i){return i?void this.create(e,t).isUsable(n,s):n.call(s,!1)},this):n.call(s,!1)},create:function(e,t){var n=e.transports.eventsource=e.transports.eventsource||{},s=e.getClientId(),t=t+"/"+(s||"");return n[t]=n[t]||new this(e,t),n[t]}}),Faye.extend(Faye.Transport.EventSource.prototype,Faye.Deferrable),Faye.Transport.register("eventsource",Faye.Transport.EventSource),Faye.Transport.XHR=Faye.extend(Faye.Class(Faye.Transport,{request:function(e,t){var n=this.retry(e,t),s=Faye.URI.parse(this.endpoint).pathname,i=this,r=Faye.ENV.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;r.open("POST",s,!0),r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Pragma","no-cache"),r.setRequestHeader("X-Requested-With","XMLHttpRequest");var a=this.headers;for(var o in a)a.hasOwnProperty(o)&&r.setRequestHeader(o,a[o]);var c=function(){r.abort()};Faye.Event.on(Faye.ENV,"beforeunload",c);var u=function(){Faye.Event.detach(Faye.ENV,"beforeunload",c),r.onreadystatechange=function(){},r=null};r.onreadystatechange=function(){if(4===r.readyState){var e=null,t=r.status,s=t>=200&&300>t||304===t||1223===t;if(!s)return u(),n(),i.trigger("down");try{e=JSON.parse(r.responseText)}catch(a){}u(),e?(i.receive(e),i.trigger("up")):(n(),i.trigger("down"))}},r.send(Faye.toJSON(e))}}),{isUsable:function(e,t,n,s){n.call(s,Faye.URI.parse(t).isSameOrigin())}}),Faye.Transport.register("long-polling",Faye.Transport.XHR),Faye.Transport.CORS=Faye.extend(Faye.Class(Faye.Transport,{request:function(e,t){var n=Faye.ENV.XDomainRequest?XDomainRequest:XMLHttpRequest,s=new n,i=this.retry(e,t),r=this;s.open("POST",this.endpoint,!0),s.setRequestHeader&&s.setRequestHeader("Pragma","no-cache");var a=function(){return s?(s.onload=s.onerror=s.ontimeout=s.onprogress=null,s=null,Faye.ENV.clearTimeout(c),!0):!1};s.onload=function(){var e=null;try{e=JSON.parse(s.responseText)}catch(t){}a(),e?(r.receive(e),r.trigger("up")):(i(),r.trigger("down"))};var o=function(){a(),i(),r.trigger("down")},c=Faye.ENV.setTimeout(o,1500*t);s.onerror=o,s.ontimeout=o,s.onprogress=function(){},s.send("message="+encodeURIComponent(Faye.toJSON(e)))}}),{isUsable:function(e,t,n,s){if(Faye.URI.parse(t).isSameOrigin())return n.call(s,!1);if(Faye.ENV.XDomainRequest)return n.call(s,Faye.URI.parse(t).protocol===Faye.URI.parse(Faye.ENV.location).protocol);if(Faye.ENV.XMLHttpRequest){var i=new Faye.ENV.XMLHttpRequest;return n.call(s,void 0!==i.withCredentials)}return n.call(s,!1)}}),Faye.Transport.register("cross-origin-long-polling",Faye.Transport.CORS),Faye.Transport.JSONP=Faye.extend(Faye.Class(Faye.Transport,{shouldFlush:function(e){var t={message:Faye.toJSON(e),jsonp:"__jsonp"+Faye.Transport.JSONP._cbCount+"__"},n=Faye.URI.parse(this.endpoint,t).toURL();return n.length>=Faye.Transport.MAX_URL_LENGTH},request:function(e,t){var n={message:Faye.toJSON(e)},s=document.getElementsByTagName("head")[0],i=document.createElement("script"),r=Faye.Transport.JSONP.getCallbackName(),a=Faye.URI.parse(this.endpoint,n),o=this.retry(e,t),c=this;Faye.ENV[r]=function(e){h(),c.receive(e),c.trigger("up")};var u=Faye.ENV.setTimeout(function(){h(),o(),c.trigger("down")},1500*t),h=function(){if(!Faye.ENV[r])return!1;Faye.ENV[r]=void 0;try{delete Faye.ENV[r]}catch(e){}return Faye.ENV.clearTimeout(u),i.parentNode.removeChild(i),!0};a.params.jsonp=r,i.type="text/javascript",i.src=a.toURL(),s.appendChild(i)}}),{_cbCount:0,getCallbackName:function(){return this._cbCount+=1,"__jsonp"+this._cbCount+"__"},isUsable:function(e,t,n,s){n.call(s,!0)}}),Faye.Transport.register("callback-polling",Faye.Transport.JSONP);